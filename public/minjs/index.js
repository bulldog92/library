var app=angular.module("libraryApp",["ui.router","satellizer","ngAnimate","ngMaterial","ngMessages"]);app.config(["$stateProvider","$urlRouterProvider","$authProvider",function(e,t,o){var r=["$q","$auth",function(e,t){var o=e.defer();return t.isAuthenticated()?o.reject():o.resolve(),o.promise}],n=["$q","$location","$auth",function(e,t,o){var r=e.defer();return o.isAuthenticated()?r.resolve():t.path("/login"),r.promise}],l=["$q","$location","$auth","Account","$rootScope",function(e,t,o,r,n){var l=e.defer();if(n.user)"admin"==n.user.role?l.resolve():t.path("/login");else{var i=r.getProfile();i.then(function(e){"admin"==e.data.role?l.resolve():t.path("/login")},function(e){t.path("/login"),console.log(e)})}return l.promise}];e.state("home",{url:"/",templateUrl:"templates/main.html",controller:"MainCtrl"}).state("register",{url:"/register",templateUrl:"templates/register.html",controller:"AuthCtrl",resolve:{skipIfLoggedIn:r}}).state("login",{url:"/login",templateUrl:"templates/login.html",controller:"AuthCtrl"}).state("logout",{url:"/logout",template:null,controller:"LogoutCtrl"}).state("profile",{url:"/profile",templateUrl:"templates/profile.html",controller:"ProfileCtrl",resolve:{loginRequired:n}}).state("onlyAdmin",{url:"/onlyAdmin",templateUrl:"templates/only_admin.html",controller:"onlyAdminCtrl",resolve:{adminLogin:l}}).state("forgot_pass",{url:"/forgot_pass",templateUrl:"templates/forgot_pass.html",controller:"forgotpassCtrl",resolve:{skipIfLoggedIn:r}}),t.otherwise("/")}]),app.controller("AuthCtrl",["$scope","$auth","$location","Account","$mdToast",function(e,t,o,r,n){e.newUser={},e.errorMessage=!1,e.register=function(){t.signup(e.newUser).then(function(e){t.setToken(e),r.setUser().then(function(e){o.path("/")})})["catch"](function(t){console.log(t),e.errorMessage=t.data.message})},e.loginUser={},e.login=function(){t.login(e.loginUser).then(function(){n.show(n.simple().textContent("Вход").position("top right").hideDelay(2e3)),r.setUser().then(function(e){o.path("/")})})["catch"](function(t){console.log(t),e.errorMessage=t.data.message})}}]),app.controller("forgotpassCtrl",["$scope","Account","$location","$timeout",function(e,t,o,r){e.forgotAccount={},e.forgotSubmit=function(){var n=t.forgotPass(e.forgotAccount);n.then(function(t){"200"==t.status?(e.successMessage="Новый пароль отправлен на почту",r(function(){o.path("/login")},1500)):e.errorMessage="При отправке произошла ошибка"},function(t){e.errorMessage="При отправке произошла ошибка"})}}]),app.controller("LogoutCtrl",["$location","$auth","$rootScope","$mdToast",function(e,t,o,r){t.isAuthenticated()&&t.logout().then(function(){r.show(r.simple().textContent("Пока").position("top right").hideDelay(2e3)),o.user={},e.path("/")})}]),app.controller("MainCtrl",["$scope",function(e){e.button="From main controller"}]),app.controller("NavCtrl",["$scope","$auth","$rootScope","Account",function(e,t,o,r){r.setUser(),e.isAuthenticated=function(){return t.isAuthenticated()},e.isAdmin=function(){return t.isAuthenticated()?(console.log(o.user),o.user&&"admin"==o.user.role?!0:void 0):!1}}]),app.controller("onlyAdminCtrl",function(e){e.hi="Hi admin "}),app.controller("onlyAdminCtrl",["$scope",function(e){e.hi="Hi admin "}]),app.controller("ProfileCtrl",["$scope","$auth","Account","$mdToast","$document",function(e,t,o,r,n){e.editProfile={displayName:e.user.displayName,email:e.user.email},e.updateProfile=function(){e.successMessage="",e.errorMessage="",o.updateProfile(e.editProfile).then(function(t){r.show(r.simple().textContent("Профиль изменен!").position("top right").hideDelay(3e3)),e.successMessage="Профиль изменен",console.log("Profile has been updated"),console.log(t.data.message),e.user.email=e.editProfile.email,e.user.displayName=e.editProfile.displayName},function(t){"304"==t.status?(console.log("not modified"),e.errorMessage="Ничего не изменилось"):e.errorMessage=t.data.message,e.editProfile=e.user,console.log(t)})}}]);var compareTo=function(){return{require:"ngModel",scope:{otherModelValue:"=compareTo"},link:function(e,t,o,r){r.$validators.compareTo=function(t){return t==e.otherModelValue},e.$watch("otherModelValue",function(){r.$validate()})}}};app.directive("compareTo",compareTo),app.factory("Account",["$http","$rootScope",function(e,t){return{setUser:function(){return e.get("/api/me").then(function(e){t.user=e.data,console.log("data: ",t.user)})},getProfile:function(){return e.get("/api/me")},updateProfile:function(t){return e.put("/api/me",t)},forgotPass:function(t){return e.post("/api/forgot",t)}}}]);