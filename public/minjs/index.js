var app=angular.module("libraryApp",["ui.router","satellizer","ngAnimate","ngMaterial","ngMessages","ngMdIcons","md.data.table"]);app.config(["$stateProvider","$urlRouterProvider","$authProvider",function(e,t,o){var n=["$q","$auth",function(e,t){var o=e.defer();return t.isAuthenticated()?o.reject():o.resolve(),o.promise}],r=["$q","$location","$auth",function(e,t,o){var n=e.defer();return o.isAuthenticated()?n.resolve():t.path("/login"),n.promise}],i=["$q","$location","$auth","Account","$rootScope",function(e,t,o,n,r){var i=e.defer();if(r.user)"admin"==r.user.role?i.resolve():t.path("/login");else{var l=n.getProfile();l.then(function(e){"admin"==e.data.role?i.resolve():t.path("/login")},function(e){t.path("/login"),console.log(e)})}return i.promise}];e.state("home",{url:"/",templateUrl:"templates/main.html",controller:"MainCtrl",resolve:{loginRequired:r}}).state("register",{url:"/register",templateUrl:"templates/register.html",controller:"AuthCtrl",resolve:{skipIfLoggedIn:n}}).state("login",{url:"/login",templateUrl:"templates/login.html",controller:"AuthCtrl",resolve:{skipIfLoggedIn:n}}).state("logout",{url:"/logout",template:null,controller:"LogoutCtrl"}).state("profile",{url:"/profile",templateUrl:"templates/profile.html",controller:"ProfileCtrl",resolve:{loginRequired:r}}).state("onlyAdmin",{url:"/onlyAdmin",templateUrl:"templates/only_admin.html",controller:"onlyAdminCtrl",resolve:{adminLogin:i}}).state("onlyAdmin.users_list",{url:"/users_list",templateUrl:"templates/users_list.html",controller:"usersListCtrl",resolve:{adminLogin:i}}).state("forgot_pass",{url:"/forgot_pass",templateUrl:"templates/forgot_pass.html",controller:"forgotpassCtrl",resolve:{skipIfLoggedIn:n}}),t.otherwise("/")}]),app.run(["$rootScope","$state","$stateParams",function(e,t,o){e.$state=t,e.$stateParams=o,e.$on("$stateChangeSuccess",function(t,o,n,r,i){e.previousState_name=r.name,e.previousState_params=i}),e.back=function(){t.go(e.previousState_name,e.previousState_params)}}]),app.controller("AuthCtrl",["$scope","$auth","$location","Account","$mdToast",function(e,t,o,n,r,i){e.newUser={},e.errorMessage=!1,e.register=function(){t.signup(e.newUser).then(function(e){t.setToken(e),n.setUser().then(function(e){o.path("/")})})["catch"](function(t){console.log(t),e.errorMessage=t.data.message})},e.loginUser={},e.login=function(){t.login(e.loginUser).then(function(){r.show(r.simple().textContent("Вход").position("bottom right").hideDelay(1e3)),n.setUser().then(function(e){o.path("/")})})["catch"](function(t){console.log(t),e.errorMessage=t.data.message})}}]),app.controller("forgotpassCtrl",["$scope","Account","$location","$timeout",function(e,t,o,n){e.forgotAccount={},e.forgotSubmit=function(){var r=t.forgotPass(e.forgotAccount);r.then(function(t){"200"==t.status?(e.successMessage="Новый пароль отправлен на почту",n(function(){o.path("/login")},2500)):e.errorMessage="При отправке произошла ошибка"},function(t){e.errorMessage="При отправке произошла ошибка"})}}]),app.controller("leftCtrl",["$scope","$timeout","$mdSidenav","$log",function(e,t,o,n){e.close=function(){o("left").close().then(function(){n.debug("close Left is done")})}}]),app.controller("AppCtrl",["$scope","$timeout","$mdSidenav","$log",function(e,t,o,n){function r(e){return function(){o(e).toggle().then(function(){n.debug("toggle "+e+" is done")})}}e.toggleLeft=r("left"),e.isOpenLeft=function(){return o("left").isOpen()}}]),app.controller("LogoutCtrl",["$location","$auth","$rootScope","$mdToast",function(e,t,o,n){t.isAuthenticated()&&t.logout().then(function(){n.show(n.simple().textContent("Пока").position("bottom right").hideDelay(1e3)),o.user={},e.path("/login")})}]),app.controller("MainCtrl",["$scope","$timeout","$rootScope","Sites","Servers","$mdDialog","$mdToast",function(e,t,o,n,r,i,l){"use strict";function s(){e.promiseSites=n.getSites(),e.promiseSites.then(function(e){o.arrSites=e},function(e){console.log(e)})}function a(t){i.show({controller:"siteDialogCtrl",templateUrl:"../templates/site_edit_popup.html",parent:angular.element(document.body),targetEvent:t,clickOutsideToClose:!0,bindToController:!0,locals:{currentSite:e.popup_site}})}function u(e){i.show({controller:"siteDialogCtrl",templateUrl:"../templates/site_add_popup.html",parent:angular.element(document.body),targetEvent:e,clickOutsideToClose:!0,bindToController:!0,locals:{currentSite:{}}})}function c(t){i.show({controller:"serverDialogCtrl",templateUrl:"../templates/server_edit_popup.html",parent:angular.element(document.body),targetEvent:t,clickOutsideToClose:!0,bindToController:!0,locals:{currentServer:e.popup_server,reloadServers:d}})}function p(e){i.show({controller:"serverDialogCtrl",templateUrl:"../templates/server_add_popup.html",parent:angular.element(document.body),targetEvent:e,clickOutsideToClose:!0,bindToController:!0,locals:{currentSite:{},reloadServers:d}})}function d(){var t=r.getServers();e.promiseServers=t,t.then(function(e){o.arrServers=e},function(e){console.log(e)})}e.query={order:"domain"},e.logOrder=function(e){console.log("order: ",e)},e.removeFilter=function(){e.filter.show=!1,e.filter.form.$dirty&&(e.query.filter="",e.filter.form.$setPristine())},e.loadStuff=function(){e.promise=n.getSites(),console.log(e.promise)},s(),e.editSite=function(t,o){e.popup_site=o,a(t)},e.addSite=function(e){u(e)},e.delSite=function(e,t){console.log(t);var o=i.confirm().title("Вы уверенны?").textContent("Сайт удалится безвозвратно").ariaLabel("Delete Site").targetEvent(e).ok("Удалить!").cancel("Отмена");i.show(o).then(function(){n.delSite(t).then(function(e){l.show(l.simple().textContent("Сайт удален").position("bottom right").hideDelay(2e3)),i.hide(),console.log(e.data.message),s()},function(e){l.show(l.simple().textContent("Ошибка").position("bottom right").hideDelay(1e3)),console.log(e)})},function(){i.hide()})},e.editServer=function(t,o){e.popup_server=o,c(t)},e.addServer=function(e){p(e)},e.deleteServer=function(e,t){console.log(t);var o=i.confirm().title("Вы уверенны?").textContent('Cервер "'+t.name+'" удалится безвозвратно').ariaLabel("Delete Server").targetEvent(e).ok("Удалить!").cancel("Отмена");i.show(o).then(function(){r.deleteServer(t).then(function(e){l.show(l.simple().textContent("Сервер удален").position("bottom right").hideDelay(1e3)),i.hide(),console.log(e.data.message),d()},function(e){l.show(l.simple().textContent("Ошибка").position("bottom right").hideDelay(1e3)),console.log(e)})},function(){i.hide()})},d()}]),app.controller("NavCtrl",["$scope","$auth","$rootScope","Account",function(e,t,o,n){n.setUser(),e.isAuthenticated=function(){return t.isAuthenticated()},e.isAdmin=function(){return t.isAuthenticated()?o.user&&"admin"==o.user.role?!0:void 0:!1}}]),app.controller("onlyAdminCtrl",function(e){e.hi="Hi admin "}),app.controller("onlyAdminCtrl",["$scope",function(e){e.hi="Hi admin "}]),app.controller("ProfileCtrl",["$scope","$auth","Account","$mdToast","$document",function(e,t,o,n,r){e.editProfile={displayName:e.user.displayName,email:e.user.email},e.updateProfile=function(){e.successMessage="",e.errorMessage="",o.updateProfile(e.editProfile).then(function(t){n.show(n.simple().textContent("Профиль изменен!").position("bottom right").hideDelay(3e3)),e.successMessage="Профиль изменен",console.log("Profile has been updated"),console.log(t.data.message),e.user.email=e.editProfile.email,e.user.displayName=e.editProfile.displayName},function(t){"304"==t.status?(console.log("not modified"),e.errorMessage="Ничего не изменилось"):e.errorMessage=t.data.message,e.editProfile=e.user,console.log(t)})}}]),app.controller("serverDialogCtrl",["$scope","$rootScope","$mdDialog","locals","Servers","$mdToast",function(e,t,o,n,r,i){e.server=n.currentServer,e.newServer={},e.cancel=function(){o.cancel(),n.reloadServers()},e.update_server=function(){var t=n.currentServer;t.name=e.server.name,t.ip=e.server.ip,t.pass=e.server.pass,r.updateServer(t).then(function(e){i.show(i.simple().textContent("Сервер изменен").position("bottom right").hideDelay(1500)),o.hide()},function(e){i.show(i.simple().textContent("Ошибка").position("bottom right").hideDelay(1e3))})},e.addServer=function(){var t=e.newServer;console.log(t),r.addNew(t).then(function(){i.show(i.simple().textContent("Сервер создан").position("bottom right").hideDelay(1500)),o.hide(),n.reloadServers()},function(){i.show(i.simple().textContent("Ошибка").position("bottom right").hideDelay(1e3))})}}]),app.controller("siteDialogCtrl",["$scope","$rootScope","$mdDialog","locals","Sites","$mdToast",function(e,t,o,n,r,i){function l(){r.getSites().then(function(e){t.arrSites=e},function(e){console.log(e)})}e.site=n.currentSite,e.newSite={},e.cancel=function(){o.cancel(),l()},e.update_site=function(){var t=n.currentSite;t.domain=e.site.domain,t.date=e.site.date,t.ip=e.site.ip,t.server=e.site.server,r.updateSite(t).then(function(e){i.show(i.simple().textContent("Сайт изменен").position("bottom right").hideDelay(2e3)),o.hide()},function(e){i.show(i.simple().textContent("Ошибка").position("bottom right").hideDelay(1e3))})},e.addSite=function(){var t=e.newSite;console.log(t),r.addNew(t).then(function(){i.show(i.simple().textContent("Сайт создан").position("bottom right").hideDelay(2e3)),o.hide(),l()},function(){i.show(i.simple().textContent("Ошибка").position("bottom right").hideDelay(1e3))})}}]),app.controller("userDialogCtrl",["$scope","$mdDialog","locals","usersList","$mdToast",function(e,t,o,n,r){e.role=o.currentUser.role,e.roles=["admin","user"],e.cancel=function(){t.cancel()},e.update_user=function(){var i=o.currentUser;i.role=e.role,n.changeRole(i).then(function(e){r.show(r.simple().textContent("Пользователь изменен").position("bottom right").hideDelay(1e3)),console.log(e),t.hide()},function(e){r.show(r.simple().textContent("Ошибка").position("bottom right").hideDelay(1e3)),console.log(e)})}}]),app.controller("usersListCtrl",["$scope","usersList","$mdDialog","$mdToast",function(e,t,o,n){function r(t){e.users=t,console.log(e.users)}function i(t){o.show({controller:"userDialogCtrl",templateUrl:"../templates/user_popup.html",parent:angular.element(document.body),targetEvent:t,clickOutsideToClose:!0,bindToController:!0,locals:{currentUser:e.popup_user}})}t.getUsers(r),e.editUser=function(t,o){e.popup_user=o,i(t)},e.deleteUser=function(e,i){console.log(i);var l=o.confirm().title("Вы уверенны?").textContent("Пользователь удалится безвозвратно").ariaLabel("Delete user").targetEvent(e).ok("Удалить!").cancel("Отмена");o.show(l).then(function(){console.log(i),t.deleteUser(i).then(function(e){console.log(e),n.show(n.simple().textContent("Пользователь удален").position("bottom right").hideDelay(1e3)),t.getUsers(r)},function(e){console.log(e),n.show(n.simple().textContent("Ошибка при удалении").position("bottom right").hideDelay(1e3))})},function(){o.hide()})}}]);var compareTo=function(){return{require:"ngModel",scope:{otherModelValue:"=compareTo"},link:function(e,t,o,n){n.$validators.compareTo=function(t){return t==e.otherModelValue},e.$watch("otherModelValue",function(){n.$validate()})}}};app.directive("compareTo",compareTo),app.factory("Account",["$http","$rootScope",function(e,t){return{setUser:function(){return e.get("/api/me").then(function(e){t.user=e.data,console.log("data: ",t.user)})},getProfile:function(){return e.get("/api/me")},updateProfile:function(t){return e.put("/api/me",t)},forgotPass:function(t){return e.post("/api/forgot",t)}}}]),app.factory("Servers",["$http","$q",function(e,t){function o(){var o=t.defer();return e({method:"GET",url:"/api/servers"}).then(function(e){l=e.data,o.resolve(l)},function(e){o.reject(e)}),o.promise}function n(t){return e({method:"PUT",url:"/api/servers",data:t})}function r(t){return e({method:"POST",data:t,url:"/api/servers"})}function i(t){return e({method:"DELETE",url:"/api/servers/"+t._id})}var l=null;return{getServers:o,updateServer:n,addNew:r,deleteServer:i}}]),app.factory("Sites",["$http","$q",function(e,t){function o(){var o=t.defer();return e({method:"GET",url:"/api/sites"}).then(function(e){o.resolve(e.data)},function(e){o.reject(e)}),o.promise}function n(t){return e({method:"PUT",data:t,url:"/api/sites"})}function r(t){return e({method:"POST",data:t,url:"/api/sites"})}function i(t){return e({method:"DELETE",url:"/api/sites/"+t._id})}return{getSites:o,updateSite:n,addNew:r,delSite:i}}]),app.factory("usersList",["$http",function(e){function t(t){e({method:"GET",url:"/api/user"}).then(function(e){r=e.data,t(r)},function(e){console.log(e)})}function o(t){return e({method:"PUT",url:"/api/user",data:t})}function n(t){return e({method:"POST",url:"/api/user_delete",data:t})}var r=null;return{getUsers:t,changeRole:o,deleteUser:n}}]);